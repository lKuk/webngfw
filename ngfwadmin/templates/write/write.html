{% extends "base.html" %}
{% load static %}
{% load base_tag %}


{# Стили #}
{% block style %}
    <link rel="stylesheet" href="{% static 'main/plugins/data-tables/css/datatables.min.css' %}">
    <link rel="stylesheet" href="{% static 'main/plugins/footable/css/footable.bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'main/plugins/footable/css/footable.standalone.min.css' %}">
{% endblock style %}

{# Скрипты #}
{% block script %}
    <script src="{% static 'main/js/pages/tbl-datatable-custom.js' %}"></script>
    <script src="{% static 'main/plugins/data-tables/js/datatables.min.js' %}"></script>
    <script src="{% static 'language/ru-table.js' %}"></script>

    <script>
        function ReadOnlyOnLoad() {
            let portIn = document.getElementById('portWriteInText')
            let portOut = document.getElementById('portwriteOutText')

            let portInBtn = document.getElementById('writeInSave')
            let portOutBtn = document.getElementById('writeOutSave')

            if (portInBtn.value === 'write') {
                portIn.readOnly = true;
            }
            if (portOutBtn.value === 'write') {
                portOut.readOnly = true;
            }
        }

        // Скрипт валидации
        function Validate(elementId, validLiId, validDivId, format, text) {
            // Получить контролы валидации
            const element = document.getElementById(elementId);
            const validLi = document.getElementById(validLiId);
            const validDiv = document.getElementById(validDivId);
            // Выполнить проверку содержимого
            validDiv.hidden = true;

            if (element.value === 'all') {
                return true
            }

            var arrayStr = element.value.split(',')

            let result = true;

            for (let port of arrayStr) {
                if (port.trim().match(format)) {
                } else {
                    result = false
                    // Отобразить ошибку
                    validDiv.hidden = false;
                    validDiv.classList.add('text-danger');
                    validDiv.classList.remove("invalid-feedback");
                    text += ' ' + port + ';';
                }
            }
            validLi.textContent = text;
            return result;
        }

        // Валидация в зависимости от формата
        function ValidateAll(inOut) {
            // определить формат валидации
            const formatPort = /^((6553[0-5])|(655[0-2][0-9])|(65[0-4][0-9]{2})|(6[0-4][0-9]{3})|([1-5][0-9]{4})|([0-5]{0,5})|([0-9]{1,4}))$/;

            let res = true;

            if (inOut === 'writeInSave') {
                // выполнить валидацию
                res = Validate("portWriteInText", "validLi_portWriteInText", "validDiv_portWriteInText", formatPort, "Неверное значение порта:");
            }
            if (inOut === 'writeOutSave') {
                // выполнить валидацию
                res = Validate("portwriteOutText", "validLi_portwriteOutText", "validDiv_portwriteOutText", formatPort, "Неверное значение порта:");
            }
            return res
        }

        // Запрос данных Ajax
        function PostPortAjax() {
            var id = event.target.id;
            let port = '';
            let checked = event.target.value;
            let valid = true;

            if (id === 'writeInSave') {
                port = document.getElementById('portWriteInText')
            }
            if (id === 'writeOutSave') {
                port = document.getElementById('portwriteOutText')
            }

            let portValue = port.value
            // Параметры
            const param = {
                type: "GET",
                dataType: "json",
                url: '{% url 'write' %}',
                data: {write_status: checked, port: portValue, write: id},
            }

            valid = ValidateAll(id)

            if (valid === true) {
                // Выполнить запрос
                $.ajax(param);

                if (event.target.textContent === 'Старт') {
                    event.target.textContent = 'Стоп'
                    port.readOnly = true;
                } else {
                    event.target.textContent = 'Старт'
                    port.readOnly = false;
                }
            }


        }

        var idSave = ''

        function SavePcap() {
            idSave = event.target.id
            // Параметры
            const param = {
                type: "GET",
                dataType: "html",
                data: {pcap: idSave},
                url: '{% url 'write' %}',
                success: Save
            }
            // Выполнить запрос
            $.ajax(param);
        }

        // Сохранение файла конфигурации
        function Save(data) {
            DownloadFile(data, idSave, "pcap")
        }

        // Функция скачивания файла
        function DownloadFile(data, filename, type) {
            const file = new Blob([data], {type: type});
            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                const a = document.createElement("a"),
                    url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function () {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }
        }

        // Запуск при загрузке страницы
        window.addEventListener('load', () => {
            ReadOnlyOnLoad();
        });
    </script>

{% endblock script %}

{# Заголовок #}
{% block header %}
    <li class="m-l-5 m-t-5">
        <h4>
            <i class="m-r-15 feather icon-file-text"></i>Запись входящего и исходящего сетевого трафика
        </h4>
    </li>
    <ul class="breadcrumb my-0 py-0 m-l-30 p-l-50 bg-transparent">
        <li class="breadcrumb-item"><a href="{% url 'write' %}">Запись трафика</a></li>
    </ul>
{% endblock header %}

{# Содержимое #}
{% block content %}
    <div class="page-wrapper">
        <div class="row">
            <div class="col-auto col-sm-6">
                <div class="card">
                    <div class="card-header">
                        <div class="page-header-title">
                            <h5>Запись входящего трафика</h5>
                        </div>
                    </div>
                    <div class="card-body" style="margin-top: 0; padding-top: 10px">
                        <div class="row">
                            <div class="col">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <button id="writeInSave" class="btn btn-primary" type="button"
                                                value="{{ writeIn.write_statusin }}" onclick="PostPortAjax()">
                                            {% if writeIn.write_statusin == 'write' %}Стоп{% else %}
                                                Старт{% endif %}</button>
                                    </div>
                                    <input id="portWriteInText" type="text" class="form-control"
                                           value="{{ writeIn.write_portin }}">
                                </div>
                                <div class="invalid-feedback" id="validDiv_portWriteInText">
                                    <ul>
                                        <li id="validLi_portWriteInText"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-auto col-sm-6">
                <div class="card">
                    <div class="card-header">
                        <div class="page-header-title">
                            <h5>Запись исходящего трафика</h5>
                        </div>
                    </div>
                    <div class="card-body" style="margin-top: 0; padding-top: 10px">
                        <div class="row">
                            <div class="col">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <button id="writeOutSave" class="btn btn-primary" type="button"
                                                value="{{ writeOut.write_statusout }}" onclick="PostPortAjax()">
                                            {% if writeOut.write_statusout == 'write' %}Стоп{% else %}
                                                Старт{% endif %}</button>
                                    </div>
                                    <input id="portwriteOutText" type="text" class="form-control"
                                           value="{{ writeOut.write_portout }}">
                                </div>
                                <div class="invalid-feedback" id="validDiv_portwriteOutText">
                                    <ul>
                                        <li id="validLi_portwriteOutText"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-auto col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <div class="page-header-title">
                            <h5>Файлы записи сетевого трафика</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="col">
                            <div class="table-responsive">
                                <table id="col-reorder"
                                       class="display table nowrap table-striped table-hover footable"
                                       style="width:100%">
                                    <thead>
                                    <tr>
                                        <th title="Удалить"><i class="feather icon-trash"></i></th>
                                        <th>Файл</th>
                                        <th title="Сохранить"><i class="feather feather icon-save"></i></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for file in content.name %}
                                        <tr>
                                            <!-- Удалить -->
                                            <td style="display: table-cell;">
                                                <div>
                                                    <a href="{% url 'write' %}?delete={{ file }}"
                                                       onclick="return confirm('Удалить файл {{ file }}?');">
                                                        <i class="feather icon-trash"></i>
                                                    </a>
                                                </div>
                                            </td>
                                            <!-- Имя файла -->
                                            <td style="display: table-cell;">{{ file }}</td>
                                            <!-- Сохранить -->
                                            <td style="display: table-cell;">
                                                <div>
                                                    <a href="#"><i id="{{ file }}" onclick="SavePcap()"
                                                                   class="feather icon-save"></i></a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}