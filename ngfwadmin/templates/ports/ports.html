{% extends "base.html" %}
{% load static %}

{# Стили #}
{% block style %}
    <link rel="stylesheet" href="{% static 'main/plugins/data-tables/css/datatables.min.css' %}">
    <link rel="stylesheet" href="{% static 'main/plugins/footable/css/footable.bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'main/plugins/footable/css/footable.standalone.min.css' %}">
{% endblock style %}

{# Скрипты #}
{% block script %}
    <script>
        // Запрос данных Ajax
        function RequestAjax() {
            // Параметры
            const param = {
                type: 'GET',
                dataType: 'json',
                url: '{% url 'ports' %}?ajax',
                success: Update
            }
            // Выполнить запрос
            $.ajax(param);
            // Запустить повторно по таймеру
            setTimeout(RequestAjax, 1000);
        }

        // Преобразовать в систему СИ
        function formatSi(val) {
            if (val === 0)
                return '0 ';
            const dec = 1;
            const k = 1024;
            const dm = dec < 0 ? 0 : dec;
            const sizes = ['', 'К', 'М', 'Г', 'Т', ''];
            const i = Math.floor(Math.log(val) / Math.log(k));
            return parseFloat((val / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Обновление страницы
        function Update(response) {
            // Время работы
            if ('ports' in response) {
                let ports = response.ports;
                let portsJson = JSON.stringify(ports);
                const ex = JSON.parse(portsJson);
                for (const [key, value] of Object.entries(ex)) {
                    let oneport = JSON.stringify(value);
                    const exOnePort = JSON.parse(oneport);

                    // Верхняя строка - Номер порта
                    var number = exOnePort['number'];
                    var numberEl = document.getElementById(number);
                    numberEl.textContent = number;

                    // Верхняя строка - Статус порта
                    var link_status = exOnePort['link_status'];
                    var link_statusEl = document.getElementById(number + "_" + "link_status");
                    link_statusEl.textContent = link_status;

                    // Верхняя строка - Скорость порта
                    var link_speed = exOnePort['link_speed'];
                    var link_speedEl = document.getElementById(number + "_" + "link_speed");
                    link_speedEl.textContent = link_speed + ' Мбит';

                    ///////////////////////////////////////////////////////////////////////

                    // Левая колонка - входящий - скорость порта
                    var ibits_per_sec = exOnePort['ibits_per_sec'];
                    var ibits_per_secEl = document.getElementById(number + "_" + "ibits_per_sec");
                    ibits_per_secEl.textContent = formatSi(ibits_per_sec) + "бит/cек";

                    // Левая колонка - входящий - количество пакетов порта
                    var ipackets = exOnePort['ipackets'];
                    var ipacketsEl = document.getElementById(number + "_" + "ipackets");
                    ipacketsEl.textContent = formatSi(parseInt(ipackets)) + "шт";

                    // Левая колонка - входящий - количество пакетов в секунду
                    var ipackets_per_sec = exOnePort['ipackets_per_sec'];
                    var ipackets_per_secEl = document.getElementById(number + "_" + "ipackets_per_sec");
                    ipackets_per_secEl.textContent = formatSi(parseInt(ipackets_per_sec)) + "шт/сек";

                    // Левая колонка - входящий - количество байт прошедших через порт
                    var ibytes = exOnePort['ibytes'];
                    var ibytesEl = document.getElementById(number + "_" + "ibytes");
                    ibytesEl.textContent = formatSi(parseInt(ibytes)) + 'байт';

                    ///////////////////////////////////////////////////////////////////////

                    // Правая колонка - исходящий - скорость порта
                    var obits_per_sec = exOnePort['obits_per_sec'];
                    var obits_per_secEl = document.getElementById(number + "_" + "obits_per_sec");
                    obits_per_secEl.textContent = formatSi(parseInt(obits_per_sec)) + "бит/cек";

                    // Правая колонка - исходящий - количество пакетов порта
                    var opackets = exOnePort['opackets'];
                    var opacketsEl = document.getElementById(number + "_" + "opackets");
                    opacketsEl.textContent = formatSi(parseInt(opackets)) + "шт";

                    // Правая колонка - исходящий - количество пакетов в секунду
                    var opackets_per_sec = exOnePort['opackets_per_sec'];
                    var opackets_per_secEl = document.getElementById(number + "_" + "opackets_per_sec");
                    opackets_per_secEl.textContent = formatSi(parseInt(opackets_per_sec)) + "шт/сек";

                    // Правая колонка - исходящий - количество байт прошедших через порт
                    var obytes = exOnePort['obytes'];
                    var obytesEl = document.getElementById(number + "_" + "obytes");
                    obytesEl.textContent = formatSi(parseInt(obytes)) + 'байт';

                    ///////////////////////////////////////////////////////////////////////

                    //+
                    var imissed_per_sec = exOnePort['imissed_per_sec'];
                    var imissed_per_secEl = document.getElementById(number + "_" + "imissed_per_sec");
                    imissed_per_secEl.textContent = formatSi(parseInt(imissed_per_sec)) + "";

                    //+
                    var ierrors = exOnePort['ierrors'];
                    var ierrorsEl = document.getElementById(number + "_" + "ierrors");
                    ierrorsEl.textContent = formatSi(parseInt(ierrors)) + "";

                    //+
                    var imissed = exOnePort['imissed'];
                    var imissedEl = document.getElementById(number + "_" + "imissed");
                    imissedEl.textContent = formatSi(parseInt(imissed)) + "";


                    //+
                    var oerrors = exOnePort['oerrors'];
                    var oerrorsEl = document.getElementById(number + "_" + "oerrors");
                    oerrorsEl.textContent = formatSi(parseInt(oerrors)) + "";
                }
            }
            if ('mgmnt_stat' in response) {
                var mgmnt_stat = response.mgmnt_stat;
                var exMgmnt_stat = JSON.stringify(mgmnt_stat);
                const ex = JSON.parse(exMgmnt_stat)

                let tdrop = ex.tdrop;
                let tdropEl = document.getElementById('mgmnt_stat_tdrop');
                tdropEl.textContent = formatSi(tdrop) + '';

                let terrs = ex.terrs;
                let terrsEl = document.getElementById('mgmnt_stat_terrs');
                terrsEl.textContent = formatSi(terrs) + '';

                let tpackets = ex.tpackets;
                let tpacketsEl = document.getElementById('mgmnt_stat_tpackets');
                tpacketsEl.textContent = formatSi(tpackets) + 'шт';

                let tbytes = ex.tbytes;
                let tbytesEl = document.getElementById('mgmnt_stat_tbytes');
                tbytesEl.textContent = formatSi(tbytes) + 'байт';

                let rdrop = ex.rdrop;
                let rdropEl = document.getElementById('mgmnt_stat_rdrop');
                rdropEl.textContent = formatSi(rdrop) + '';

                let rerrs = ex.rerrs;
                let rerrsEl = document.getElementById('mgmnt_stat_rerrs');
                rerrsEl.textContent = formatSi(rerrs) + '';

                let rpackets = ex.rpackets;
                let rpacketsEl = document.getElementById('mgmnt_stat_rpackets');
                rpacketsEl.textContent = formatSi(rpackets) + 'шт';

                let rbytes = ex.rbytes;
                let rbytesEl = document.getElementById('mgmnt_stat_rbytes');
                rbytesEl.textContent = formatSi(rbytes) + 'байт';
            }
            if ('graylog' in response) {
                var graylog = response.graylog;
                var exGraylog = JSON.stringify(graylog);
                const ex = JSON.parse(exGraylog)

                let tdrop = ex.tdrop;
                let tdropEl = document.getElementById('graylog_tdrop');
                tdropEl.textContent = formatSi(tdrop) + '';

                let terrs = ex.terrs;
                let terrsEl = document.getElementById('graylog_terrs');
                terrsEl.textContent = formatSi(terrs) + '';

                let tpackets = ex.tpackets;
                let tpacketsEl = document.getElementById('graylog_tpackets');
                tpacketsEl.textContent = formatSi(tpackets) + 'шт';

                let tbytes = ex.tbytes;
                let tbytesEl = document.getElementById('graylog_tbytes');
                tbytesEl.textContent = formatSi(tbytes) + 'байт';

                let rdrop = ex.rdrop;
                let rdropEl = document.getElementById('graylog_rdrop');
                rdropEl.textContent = formatSi(rdrop) + '';

                let rerrs = ex.rerrs;
                let rerrsEl = document.getElementById('graylog_rerrs');
                rerrsEl.textContent = formatSi(rerrs) + '';

                let rpackets = ex.rpackets;
                let rpacketsEl = document.getElementById('graylog_rpackets');
                rpacketsEl.textContent = formatSi(rpackets) + 'шт';

                let rbytes = ex.rbytes;
                let rbytesEl = document.getElementById('graylog_rbytes');
                rbytesEl.textContent = formatSi(rbytes) + 'байт';
            }
        }

        // Запуск при загрузке страницы
        window.addEventListener('load', () => {
            RequestAjax();
        });
    </script>
{% endblock script %}

{# Заголовок #}
{% block header %}
    <li class="m-l-5 m-t-5">
        <h4>
            <i class="m-r-15 feather icon-airplay"></i>Физические порты устройства
        </h4>
    </li>
    <ul class="breadcrumb my-0 py-0 m-l-30 p-l-50 bg-transparent">
        <li class="breadcrumb-item"><a href="{% url 'ports' %}">Порты</a></li>
    </ul>

{% endblock header %}

{# Содержимое #}
{% block content %}
    <div class="page-wrapper">
        <div class="card">
            <div class="card-header">
                <div class="page-header-title">
                    <h5>Состояние портов</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row p-2">
                    <div class="col-auto p-0">
                        <div class="card-body" style="width: 300px">
                            <div class="row border border-dark p-t-5" style="background: #9dc1d3">
                                <div class="col-auto text-right px-2">
                                    <img src="{% static 'main/svg/ethernet.svg' %}" width="26" height="26" alt=""
                                         class="bg-white">
                                </div>
                                <div class="col p-t-5" data-toggle="tooltip" title="Интерфейс управления">
                                    <h5 id="mgmnt_stat">Управление</h5>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6 border border-dark border-top-0 border-right-0 p-t-5"
                                     style="background: #ddf1ff">
                                    <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                         title="Вх. пакетов">
                                        <h6 id="mgmnt_stat_rpackets">0</h6>
                                    </div>
                                    <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                         title="Вх. байт">
                                        <h6 id="mgmnt_stat_rbytes">0</h6>
                                    </div>
                                </div>
                                <div class="col-sm-6 border-bottom border-right border-dark p-t-5"
                                     style="background: #ddf1ff">
                                    <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                         title="Исх. пакетов">
                                        <h6 id="mgmnt_stat_tpackets">0</h6>
                                    </div>
                                    <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                         title="Исх. байт">
                                        <h6 id="mgmnt_stat_tbytes">0</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="row border border-top-0 border-dark text-center"
                                 style="background: peachpuff">
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Вх. ошибок">
                                    <h6 id="mgmnt_stat_rerrs" class="my-1">0</h6>
                                </div>
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Вх. потеряно байт">
                                    <h6 id="mgmnt_stat_rdrop" class="my-1">0</h6>
                                </div>
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Исх. ошибок">
                                    <h6 id="mgmnt_stat_terrs" class="my-1">0</h6>
                                </div>
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Исх потеряно байт">
                                    <h6 id="mgmnt_stat_tdrop" class="my-1">0</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto p-0">
                        <div class="card-body" style="width: 300px">
                            <div class="row border border-dark p-t-5" style="background: #9dc1d3">
                                <div class="col-auto text-right px-2">
                                    <img src="{% static 'main/svg/ethernet.svg' %}" width="26" height="26" alt=""
                                         class="bg-white">
                                </div>
                                <div class="col p-t-5" data-toggle="tooltip" title="Интерфейс логирования">
                                    <h5 id="graylog">Логирование</h5>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6 border border-dark border-top-0 border-right-0 p-t-5"
                                     style="background: #ddf1ff">
                                    <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                         title="Вх. пакетов">
                                        <h6 id="graylog_rpackets">0</h6>
                                    </div>
                                    <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                         title="Вх. байт">
                                        <h6 id="graylog_rbytes">0</h6>
                                    </div>
                                </div>
                                <div class="col-sm-6 border-bottom border-right border-dark p-t-5"
                                     style="background: #ddf1ff">
                                    <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                         title="Исх. пакетов">
                                        <h6 id="graylog_tpackets">0</h6>
                                    </div>
                                    <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                         title="Исх. байт">
                                        <h6 id="graylog_tbytes">0</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="row border border-top-0 border-dark text-center"
                                 style="background: peachpuff">
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Вх. ошибок">
                                    <h6 id="graylog_rerrs" class="my-1">0</h6>
                                </div>
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Вх. потеряно байт">
                                    <h6 id="graylog_rdrop" class="my-1">0</h6>
                                </div>
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Исх. ошибок">
                                    <h6 id="graylog_terrs" class="my-1">0</h6>
                                </div>
                                <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                     title="Исх потеряно байт">
                                    <h6 id="graylog_tdrop" class="my-1">0</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row p-2">
                    {% for p in ports %}
                        <div class="col-auto p-0">
                            <div class="card-body" style="width: 300px">
                                <div class="row border border-dark p-t-5" style="background: #9dc1d3">
                                    <div class="col-auto text-right px-2">
                                        <img src="{% static 'main/svg/ethernet.svg' %}" width="26" height="26" alt=""
                                             class="bg-white">
                                    </div>
                                    <div class="col-auto text-left p-t-5" data-toggle="tooltip" title="Номер порта">
                                        <h5 id="{{ p.number }}">{{ p.number }}</h5>
                                    </div>
                                    <div class="col-auto text-center p-t-5" data-toggle="tooltip" title="Статус">
                                        <h5 id="{{ p.number }}_link_status">DOWN</h5>
                                    </div>
                                    <div class="col-auto text-left p-t-5" data-toggle="tooltip"
                                         title="Скорость порта (Мбит)">
                                        <h5 id="{{ p.number }}_link_speed">0 Мбит</h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 border border-dark border-top-0 border-right-0 text-left p-t-5"
                                         style="background: #ddf1ff">
                                        <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                             title="Вх. скорость порта">
                                            <h6 id="{{ p.number }}_ibits_per_sec">0</h6>
                                        </div>
                                        <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                             title="Вх. количество байт">
                                            <h6 id="{{ p.number }}_ibytes">0</h6>
                                        </div>
                                        <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                             title="Вх. скорость пакетов">
                                            <h6 id="{{ p.number }}_ipackets_per_sec">0</h6>
                                        </div>
                                        <div class="row-auto" data-toggle="tooltip" data-placement="left"
                                             title="Вх. количество пакетов">
                                            <h6 id="{{ p.number }}_ipackets">0</h6>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 border-bottom border-right border-dark text-left p-t-5"
                                         style="background: #ddf1ff">
                                        <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                             title="Исх. скорость порта">
                                            <h6 id="{{ p.number }}_obits_per_sec">0</h6>
                                        </div>
                                        <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                             title="Исх. количество байт">
                                            <h6 id="{{ p.number }}_obytes">0</h6>
                                        </div>
                                        <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                             title="Исх. скорость пакетов">
                                            <h6 id="{{ p.number }}_opackets_per_sec">0</h6>
                                        </div>
                                        <div class="row-auto" data-toggle="tooltip" data-placement="right"
                                             title="Исх. количество пакетов">
                                            <h6 id="{{ p.number }}_opackets">0</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="row border border-top-0 border-dark text-center"
                                     style="background: peachpuff">
                                    <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                         title="Вх. потерь (шт)">
                                        <h6 id="{{ p.number }}_imissed" class="my-1">0</h6>
                                    </div>
                                    <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                         title="Вх. ск. потерь (шт/сек)">
                                        <h6 id="{{ p.number }}_imissed_per_sec" class="my-1">0</h6>
                                    </div>
                                    <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                         title="Вх. ошибок (шт)">
                                        <h6 id="{{ p.number }}_ierrors" class="my-1">0</h6>
                                    </div>
                                    <div class="col-sm-3 m-0 p-0" data-toggle="tooltip" data-placement="bottom"
                                         title="Исх. ошибок (шт)">
                                        <h6 id="{{ p.number }}_oerrors" class="my-1">0</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

{% endblock content %}