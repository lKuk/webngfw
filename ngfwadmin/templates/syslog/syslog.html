{% extends "base.html" %}
{% load static %}
{% load base_tag %}


{# Стили #}
{% block style %}
{% endblock style %}

{# Скрипты #}
{% block script %}
    <script>

        // Скрипт валидации
        function Validate(elementId, validLiId, validDivId, format, text) {
            // Получить контролы валидации
            const element = document.getElementById(elementId);
            const validLi = document.getElementById(validLiId);
            const validDiv = document.getElementById(validDivId);
            // Выполнить проверку содержимого
            validDiv.hidden = true;
            if (element.value.match(format))
                return true;
            // Отобразить ошибку
            validDiv.hidden = false;
            validDiv.classList.add('text-danger');
            validDiv.classList.remove("invalid-feedback")
            validLi.textContent = text;
            return false;
        }

        // Валидация в зависимости от формата
        function ValidateAll() {
            // определить формат валидации
            const formatIp = /(^\s*((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))\s*$)|(^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$)/;
            const formatPort = /^((6553[0-5])|(655[0-2][0-9])|(65[0-4][0-9]{2})|(6[0-4][0-9]{3})|([1-5][0-9]{4})|([0-5]{0,5})|([0-9]{1,4}))$/;

            // выполнить валидацию
            let res1 = Validate("ipText", "validLi_ipText", "validDiv_ipText", formatIp, "Введите действительный IPv4 или IPv6 адрес.");
            let res2 = Validate("portText", "validLi_portText", "validDiv_portText", formatPort, "Введите целое число от 0 до 65535.");

            // отменить отправку формы на сервер
            if (res1 === false || res2 === false) {
                return false
            }

            return true
        }

        // Запрос данных Ajax
        function PostStatusAjax() {
            var id = event.target.id
            let checked = event.target.checked;
            // Параметры
            const param = {
                type: "GET",
                dataType: "json",
                url: '{% url 'syslog' %}',
                data: {'checked': checked, typesys: id},
            }
            // Выполнить запрос
            $.ajax(param);
        }

        // Запрос данных Ajax
        function PostServerAjax() {
            let ip = document.getElementById("ipText")
            let port = document.getElementById("portText")

            let ipValue = ip.value
            let portValue = port.value
            // Параметры
            const param = {
                type: "GET",
                dataType: "json",
                url: '{% url 'syslog' %}',
                data: {ipServer: ipValue, portServer: portValue},
            }

            if (ValidateAll() === true) {
                // Выполнить запрос
                $.ajax(param);
            }
        }


    </script>

{% endblock script %}

{# Заголовок #}
{% block header %}
    <li class="m-l-5 m-t-5">
        <h4>
            <i class="m-r-15 feather icon-list"></i>Конфигурация логирования
        </h4>
    </li>
    <ul class="breadcrumb my-0 py-0 m-l-30 p-l-50 bg-transparent">
        <li class="breadcrumb-item"><a href="{% url 'syslog' %}">Логирование</a></li>
    </ul>
{% endblock header %}


{# Содержимое #}
{% block content %}
    <div class="page-wrapper">
        <div class="row">
            <div class="col-md-12 col-lg-6 col-xl-4">
                <div class="card">
                    <div class="card-header">
                        <div class="page-header-title">
                            <h5>Подключение к серверу логирования</h5>
                        </div>
                    </div>
                    <div class="card-body" style="margin-top: 0; padding-top: 10px">
                        <div class="row">
                            <div class="col">
                                <button class="btn btn-primary shadow-2" onclick="PostServerAjax()" style="width: 160px">Сохранить</button>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="ipText">IP адрес:</label>
                                    <input id="ipText" type="text" class="form-control" value="{{ server.host }}">
                                </div>
                                <div class="invalid-feedback" id="validDiv_ipText">
                                    <ul>
                                        <li id="validLi_ipText"></li>
                                    </ul>
                                </div>
                                <div class="form-group">
                                    <label for="portText">Порт:</label>
                                    <input id="portText" type="text" class="form-control" value="{{ server.port }}">
                                </div>
                                <div class="invalid-feedback" id="validDiv_portText">
                                    <ul>
                                        <li id="validLi_portText"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="card">
                    <div class="card-header">
                        <div class="page-header-title">
                            <h5>Параметры логирования</h5>
                        </div>
                    </div>
                    <div class="card-body" style="margin-top: 0; padding-top: 10px">
                        <div class="row">
                            {% for key, value in types.items %}
                                <div class="col-xl-4 col-lg-6">
                                    <div class="switch switch-primary d-inline m-r-10">
                                        <input type="checkbox" id="{{ key }}" {% if value.status %}checked{% endif %} hidden
                                               onchange="PostStatusAjax()">
                                        <label for="{{ key }}" class="cr"></label>
                                        <label class="text-dark" style="margin-left: 10px">{{ value.name }}</label>
                                        <br>
                                        <p class="text-muted m-0 py-0 p-l-50">({{ value.description }})</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}